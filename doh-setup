#!/bin/bash

# doh-setup - Setup script for the doh auto-commit system
# This script helps install doh commands and set up bash aliases

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOH_SCRIPT="$SCRIPT_DIR/doh"
DAEMON_SCRIPT="$SCRIPT_DIR/doh-daemon"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_usage() {
    echo "doh-setup - Setup the doh auto-commit system"
    echo ""
    echo "Usage: $0 [command]"
    echo ""
    echo "Commands:"
    echo "  install-aliases    Add doh aliases to ~/.bashrc"
    echo "  install-cron       Set up cron job for doh-daemon"
    echo "  install-systemd    Set up systemd timer (alternative to cron)"
    echo "  test              Test the doh system"
    echo "  uninstall         Remove aliases and cron jobs"
    echo ""
}

install_aliases() {
    local bashrc="$HOME/.bashrc"
    local alias_section="# DOH Auto-commit aliases"
    
    # Check if aliases already exist
    if grep -q "$alias_section" "$bashrc" 2>/dev/null; then
        echo -e "${YELLOW}DOH aliases already installed${NC}"
        return 0
    fi
    
    echo -e "${BLUE}Installing DOH aliases to $bashrc${NC}"
    
    cat >> "$bashrc" << EOF

$alias_section
alias doh='$DOH_SCRIPT'
alias doh-daemon='$DAEMON_SCRIPT'
alias doh-status='$DOH_SCRIPT --status'
alias doh-list='$DOH_SCRIPT --list'
alias doh-commit='$DOH_SCRIPT --force-commit'
EOF
    
    echo -e "${GREEN}✓ Aliases installed successfully${NC}"
    echo "Run 'source ~/.bashrc' or start a new terminal to use the aliases"
    echo ""
    echo "Available commands:"
    echo "  doh [threshold]     - Add current directory to monitoring"
    echo "  doh-status          - Show current directory status"
    echo "  doh-list            - List all monitored directories"
    echo "  doh-commit          - Force commit current changes"
    echo "  doh-daemon          - Run the monitoring daemon"
}

install_cron() {
    echo -e "${BLUE}Setting up cron job for doh-daemon${NC}"
    
    # Check if cron job already exists
    if crontab -l 2>/dev/null | grep -q "doh-daemon"; then
        echo -e "${YELLOW}DOH cron job already exists${NC}"
        return 0
    fi
    
    # Add cron job to run every 10 minutes
    (crontab -l 2>/dev/null; echo "*/10 * * * * $DAEMON_SCRIPT --once") | crontab -
    
    echo -e "${GREEN}✓ Cron job installed successfully${NC}"
    echo "doh-daemon will now run every 10 minutes"
    echo "View with: crontab -l"
}

install_systemd() {
    echo -e "${BLUE}Setting up systemd timer for doh-daemon${NC}"
    
    local service_file="/etc/systemd/system/doh-daemon.service"
    local timer_file="/etc/systemd/system/doh-daemon.timer"
    
    # Create service file
    sudo tee "$service_file" > /dev/null << EOF
[Unit]
Description=DOH Auto-commit daemon
After=network.target

[Service]
Type=oneshot
User=$USER
ExecStart=$DAEMON_SCRIPT --once
EOF
    
    # Create timer file
    sudo tee "$timer_file" > /dev/null << EOF
[Unit]
Description=Run DOH auto-commit daemon every 10 minutes
Requires=doh-daemon.service

[Timer]
OnCalendar=*:0/10
Persistent=true

[Install]
WantedBy=timers.target
EOF
    
    # Enable and start the timer
    sudo systemctl daemon-reload
    sudo systemctl enable doh-daemon.timer
    sudo systemctl start doh-daemon.timer
    
    echo -e "${GREEN}✓ Systemd timer installed successfully${NC}"
    echo "Check status with: systemctl status doh-daemon.timer"
}

test_system() {
    echo -e "${BLUE}Testing DOH system${NC}"
    echo ""
    
    # Test if scripts are executable
    if [[ -x "$DOH_SCRIPT" ]]; then
        echo -e "${GREEN}✓ doh script is executable${NC}"
    else
        echo -e "${RED}✗ doh script not found or not executable${NC}"
        return 1
    fi
    
    if [[ -x "$DAEMON_SCRIPT" ]]; then
        echo -e "${GREEN}✓ doh-daemon script is executable${NC}"
    else
        echo -e "${RED}✗ doh-daemon script not found or not executable${NC}"
        return 1
    fi
    
    # Test configuration check
    echo ""
    echo "Testing configuration..."
    if "$DAEMON_SCRIPT" --config-check; then
        echo -e "${GREEN}✓ Configuration check passed${NC}"
    else
        echo -e "${YELLOW}⚠ No configuration found (this is normal for first run)${NC}"
    fi
    
    echo ""
    echo "Test basic doh command..."
    "$DOH_SCRIPT" --help | head -3
    
    echo ""
    echo -e "${GREEN}✓ DOH system test completed${NC}"
    echo ""
    echo "To get started:"
    echo "1. cd to a git repository"
    echo "2. Run 'doh' to add it to monitoring"
    echo "3. Run 'doh-status' to check current status"
}

uninstall() {
    echo -e "${BLUE}Uninstalling DOH system${NC}"
    
    # Remove aliases from bashrc
    local bashrc="$HOME/.bashrc"
    if grep -q "# DOH Auto-commit aliases" "$bashrc" 2>/dev/null; then
        # Remove the section
        sed -i '/# DOH Auto-commit aliases/,/^$/d' "$bashrc"
        echo -e "${GREEN}✓ Removed aliases from ~/.bashrc${NC}"
    fi
    
    # Remove cron job
    if crontab -l 2>/dev/null | grep -q "doh-daemon"; then
        crontab -l 2>/dev/null | grep -v "doh-daemon" | crontab -
        echo -e "${GREEN}✓ Removed cron job${NC}"
    fi
    
    # Remove systemd timer if it exists
    if systemctl list-timers | grep -q doh-daemon 2>/dev/null; then
        sudo systemctl stop doh-daemon.timer
        sudo systemctl disable doh-daemon.timer
        sudo rm -f /etc/systemd/system/doh-daemon.{service,timer}
        sudo systemctl daemon-reload
        echo -e "${GREEN}✓ Removed systemd timer${NC}"
    fi
    
    echo -e "${GREEN}✓ DOH system uninstalled${NC}"
    echo "Configuration and logs in ~/.doh are preserved"
}

# Main execution
case "${1:-help}" in
    install-aliases)
        install_aliases
        ;;
    install-cron)
        install_cron
        ;;
    install-systemd)
        install_systemd
        ;;
    test)
        test_system
        ;;
    uninstall)
        uninstall
        ;;
    *)
        print_usage
        ;;
esac
